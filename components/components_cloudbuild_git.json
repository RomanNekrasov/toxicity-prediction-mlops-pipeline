{
 "steps": [
   {
      "name": "gcr.io/cloud-builders/gcloud",
      "entrypoint": "bash",
      "args": [
        "-c",
        "gcloud secrets versions access latest --secret=github-ssh-key > /root/.ssh/id_github"
      ],
      "volumes": [
        {
          "name": "ssh",
          "path": "/root/.ssh"
        }
      ]
    },
    {
      "name": "gcr.io/cloud-builders/git",
      "entrypoint": "bash",
      "args": [
        "-c",
        "chmod 600 /root/.ssh/id_github && cat <<EOF >/root/.ssh/config\nHostname github.com\nIdentityFile /root/.ssh/id_github\nEOF && ssh-keyscan -t rsa github.com > /root/.ssh/known_hosts"
      ],
      "volumes": [
        {
          "name": "ssh",
          "path": "/root/.ssh"
        }
      ]
    },
    {
      "name": "gcr.io/cloud-builders/git",
      "entrypoint": "bash",
      "args": [
        "-c",
        "echo \"Cloning repo ...\" && git clone --depth 1 git@github.com:RomanNekrasov/DataEngineering.git && echo \"data uploaded\" >> components/history.txt && echo \"Pushing changes to git repo ...\" && git config --global user.name RomanNekrasov && git config --global user.email romanvanriessen@gmail.com && git add -A && git commit -m \"data uploaded\" && git push origin master"
      ],
      "volumes": [
        {
          "name": "ssh",
          "path": "/root/.ssh"
        }
      ]
    }
 ]
}